<!-- TOC -->

<ul>
  <li><a href="#parserequestline">parseRequestLine</a>
    <ul>
      <li><a href="#阶段1--跳过所有空行">阶段1  跳过所有空行</a></li>
      <li><a href="#阶段2-获取方法名-getpost等">阶段2 获取方法名 GET/POST等</a></li>
      <li><a href="#阶段3-跳过空格和\t">阶段3 跳过空格和\t</a></li>
      <li><a href="#阶段4-读取url">阶段4 读取url</a></li>
      <li><a href="#阶段5-跳过空格和\t">阶段5 跳过空格和\t</a></li>
      <li><a href="#阶段6-读取协议protocol">阶段6 读取协议protocol</a></li>
    </ul>
  </li>
  <li><a href="#parseheaders">parseHeaders</a>
    <ul>
      <li><a href="#阶段1-跳过空行">阶段1 跳过空行</a></li>
      <li><a href="#阶段2-读取header-name">阶段2 读取header name</a></li>
      <li><a href="#阶段3-读取value">阶段3 读取value</a></li>
    </ul>
  </li>
</ul>

<!-- /TOC -->
<p>上一篇文章中介绍了tomcat的连接处理，在连接建立完毕后，tomcat通过Nio读取数据然后交给Http11Processor的service方法进行处理，整个处理过程大致分为协议解析和请求处理两步，这里大致介绍一下协议解析的过程。协议的解析过程在Http11InputBuffer中，主要工作由parseRequestLine和parseHeaders两个函数完成，前者负责解析request line（包括method, url, protocol），后者负责读取request header。</p>

<h1 id="parserequestline">parseRequestLine</h1>

<p>parseRequestLine比较长，不过代码结构相对来说比较清晰。rfc协议规定request line由method, request-uri和http-version三部分组成，中间通过分隔符进行分割。</p>

<blockquote>
  <p>The Request-Line begins with a method token, followed by the
   Request-URI and the protocol version, and ending with CRLF. The
   elements are separated by SP characters. No CR or LF is allowed
   except in the final CRLF sequence.
   Request-Line   = Method SP Request-URI SP HTTP-Version CRLF</p>
</blockquote>

<p>parseRequestLine基本上可以按照rfc协议划分为几个阶段，每个阶段有对应的parsingRequestLinePhase值来标示，每一个阶段结束后parsingRequestLinePhase都会被赋值进入到下一个阶段。如果某个阶段没有读取到数据，跳出解析后，下一次读取到数据再次进入到parseRequestLine则会根据上一次退出时parsingRequestLinePhase的状态直接进入到对应的阶段。</p>

<h2 id="阶段1--跳过所有空行">阶段1  跳过所有空行</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span> <span class="o">(</span><span class="n">parsingRequestLinePhase</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">byte</span> <span class="n">chr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">do</span> <span class="o">{</span>

                <span class="c1">// Read new bytes if needed</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">keptAlive</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// Haven't read any request data yet so use the keep-alive</span>
                        <span class="c1">// timeout.</span>
                        <span class="n">wrapper</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="n">wrapper</span><span class="o">.</span><span class="na">getEndpoint</span><span class="o">().</span><span class="na">getKeepAliveTimeout</span><span class="o">());</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">fill</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span> <span class="o">{</span>
                        <span class="c1">// A read is pending, so no longer in initial state</span>
                        <span class="n">parsingRequestLinePhase</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="c1">// At least one byte of the request has been received.</span>
                    <span class="c1">// Switch to the socket timeout.</span>
                    <span class="n">wrapper</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="n">wrapper</span><span class="o">.</span><span class="na">getEndpoint</span><span class="o">().</span><span class="na">getSoTimeout</span><span class="o">());</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">keptAlive</span> <span class="o">&amp;&amp;</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">CLIENT_PREFACE_START</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kt">boolean</span> <span class="n">prefaceMatch</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CLIENT_PREFACE_START</span><span class="o">.</span><span class="na">length</span> <span class="o">&amp;&amp;</span> <span class="n">prefaceMatch</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">CLIENT_PREFACE_START</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">!=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">prefaceMatch</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">prefaceMatch</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// HTTP/2 preface matched</span>
                        <span class="n">parsingRequestLinePhase</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="c1">// Set the start time once we start reading data (even if it is</span>
                <span class="c1">// just skipping blank lines)</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getStartTime</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">request</span><span class="o">.</span><span class="na">setStartTime</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
                <span class="o">}</span>
                <span class="n">chr</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">CR</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">LF</span><span class="o">));</span>
            <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>

            <span class="n">parsingRequestLineStart</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">();</span>
            <span class="n">parsingRequestLinePhase</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Received ["</span>
                        <span class="o">+</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">(),</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">(),</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">ISO_8859_1</span><span class="o">)</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre></div></div>
<p>首先会判断当前bytebuffer的position是否大于limit，如果大于等于则表示buffer中的所有数据已经处理完成，需要进一步读取数据。这时候则调用fill方法读取数据，如果读取到的数据是0字节，则将parsingRequestLine标记为1，并且退出parseRequestLine，service方法会根据当前状态进行下一步处理。如果读取到数据，则设置socket的timeout，并且逐个字节的从bytebuffer中读取数据，判断字符是否是\r或者\n，如果是则开始下一次循环。否则跳出循环，将position设置为position - 1，这是因为上一个读取到的字符是合法字符，后续还需要用到，同时标记parsingRequestLin为2，进入阶段2</p>

<h2 id="阶段2-获取方法名-getpost等">阶段2 获取方法名 GET/POST等</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span> <span class="o">(</span><span class="n">parsingRequestLinePhase</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//</span>
            <span class="c1">// Reading the method name</span>
            <span class="c1">// Method name is a token</span>
            <span class="c1">//</span>
            <span class="kt">boolean</span> <span class="n">space</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(!</span><span class="n">space</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Read new bytes if needed</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">fill</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span> <span class="c1">// request line parsing</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="c1">// Spec says method name is a token followed by a single SP but</span>
                <span class="c1">// also be tolerant of multiple SP and/or HT.</span>
                <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">();</span>
                <span class="kt">byte</span> <span class="n">chr</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">SP</span> <span class="o">||</span> <span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">HT</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">space</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">request</span><span class="o">.</span><span class="na">method</span><span class="o">().</span><span class="na">setBytes</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="n">parsingRequestLineStart</span><span class="o">,</span>
                            <span class="n">pos</span> <span class="o">-</span> <span class="n">parsingRequestLineStart</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">HttpParser</span><span class="o">.</span><span class="na">isToken</span><span class="o">(</span><span class="n">chr</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">sm</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"iib.invalidmethod"</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">parsingRequestLinePhase</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
        <span class="o">}</span>
</code></pre></div></div>
<p>阶段2会一直读取字符如果字符不是空格或者\t，则进入下一次循环，否则根据parsingRequestLineStart和当前position从bytebuffer中读取对应的方法名，parsingRequestLineStart作为起始位置，position作为结束位置。</p>

<h2 id="阶段3-跳过空格和t">阶段3 跳过空格和\t</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span> <span class="o">(</span><span class="n">parsingRequestLinePhase</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Spec says single SP but also be tolerant of multiple SP and/or HT</span>
            <span class="kt">boolean</span> <span class="n">space</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">space</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Read new bytes if needed</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">fill</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span> <span class="c1">// request line parsing</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="kt">byte</span> <span class="n">chr</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(!(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">SP</span> <span class="o">||</span> <span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">HT</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">space</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">parsingRequestLineStart</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">();</span>
            <span class="n">parsingRequestLinePhase</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
        <span class="o">}</span>
</code></pre></div></div>
<p>协议规定method后可以出现多个空格或者\t，所以在阶段3对这种情况做特殊处理，跳过空格和\t。</p>

<h2 id="阶段4-读取url">阶段4 读取url</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span> <span class="o">(</span><span class="n">parsingRequestLinePhase</span> <span class="o">==</span> <span class="mi">4</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Mark the current buffer position</span>

            <span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="c1">//</span>
            <span class="c1">// Reading the URI</span>
            <span class="c1">//</span>
            <span class="kt">boolean</span> <span class="n">space</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(!</span><span class="n">space</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Read new bytes if needed</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">fill</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span> <span class="c1">// request line parsing</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">();</span>
                <span class="kt">byte</span> <span class="n">chr</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">SP</span> <span class="o">||</span> <span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">HT</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">space</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">pos</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">CR</span> <span class="o">||</span> <span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">LF</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// HTTP/0.9 style request</span>
                    <span class="n">parsingRequestLineEol</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">space</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">pos</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">QUESTION</span> <span class="o">&amp;&amp;</span> <span class="n">parsingRequestLineQPos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">parsingRequestLineQPos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">HttpParser</span><span class="o">.</span><span class="na">isNotRequestTarget</span><span class="o">(</span><span class="n">chr</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">sm</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"iib.invalidRequestTarget"</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">parsingRequestLineQPos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">request</span><span class="o">.</span><span class="na">queryString</span><span class="o">().</span><span class="na">setBytes</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="n">parsingRequestLineQPos</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span>
                        <span class="n">end</span> <span class="o">-</span> <span class="n">parsingRequestLineQPos</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
                <span class="n">request</span><span class="o">.</span><span class="na">requestURI</span><span class="o">().</span><span class="na">setBytes</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="n">parsingRequestLineStart</span><span class="o">,</span>
                        <span class="n">parsingRequestLineQPos</span> <span class="o">-</span> <span class="n">parsingRequestLineStart</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">request</span><span class="o">.</span><span class="na">requestURI</span><span class="o">().</span><span class="na">setBytes</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="n">parsingRequestLineStart</span><span class="o">,</span>
                        <span class="n">end</span> <span class="o">-</span> <span class="n">parsingRequestLineStart</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">parsingRequestLinePhase</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
        <span class="o">}</span>
</code></pre></div></div>
<p>当读取的字符串是问号并且parsingRequestLineQPos是-1的时候，设置parsingRequestLineQPos为当前位置，这种情况下表明请求的url中带有参数需要记录下来。当读取的字符是空格或者\t，\r或者\n（兼容HTTP/0.9）的时候则设置end为当前位置，并且标记跳出循环。如果标记了有查询条件（parsingRequestLineQPos &gt;= 0), parsingRequestLineStart到parsingRequestLineQPos为url，parsingRequestLineQPos到end位查询条件，否则parsingRequestLineStart到end为url。</p>

<h2 id="阶段5-跳过空格和t">阶段5 跳过空格和\t</h2>
<h2 id="阶段6-读取协议protocol">阶段6 读取协议protocol</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span> <span class="o">(</span><span class="n">parsingRequestLinePhase</span> <span class="o">==</span> <span class="mi">6</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//</span>
            <span class="c1">// Reading the protocol</span>
            <span class="c1">// Protocol is always "HTTP/" DIGIT "." DIGIT</span>
            <span class="c1">//</span>
            <span class="k">while</span> <span class="o">(!</span><span class="n">parsingRequestLineEol</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Read new bytes if needed</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">fill</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span> <span class="c1">// request line parsing</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">();</span>
                <span class="kt">byte</span> <span class="n">chr</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">CR</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">pos</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">LF</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">end</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">pos</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">parsingRequestLineEol</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">HttpParser</span><span class="o">.</span><span class="na">isHttpProtocol</span><span class="o">(</span><span class="n">chr</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">sm</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"iib.invalidHttpProtocol"</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>
</code></pre></div></div>
<p>当读取到\n的时候结束protocol的解析</p>

<h1 id="parseheaders">parseHeaders</h1>

<p>首先我们需要了解下rfc中对header的定义，</p>
<blockquote>
  <p>message-header = field-name “:” [ field-value ]
       field-name     = token
       field-value    = <em>( field-content | LWS )
       field-content  = &lt;the OCTETs making up the field-value
                        and consisting of either *TEXT or combinations
                        of token, separators, and quoted-string&gt;
       LWS            = [CRLF] 1</em>( SP | HT )</p>
</blockquote>

<p>header由field-name和field-value两部分，中间使用”:”分割。field-value由field-content组成，中间会出现LWS（空格，\t，\r，\n）等。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * Parse the HTTP headers.
     */</span>
    <span class="kt">boolean</span> <span class="nf">parseHeaders</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">parsingHeader</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">sm</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"iib.parseheaders.ise.error"</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="n">HeaderParseStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">HeaderParseStatus</span><span class="o">.</span><span class="na">HAVE_MORE_HEADERS</span><span class="o">;</span>

        <span class="k">do</span> <span class="o">{</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">parseHeader</span><span class="o">();</span>
            <span class="c1">// Checking that</span>
            <span class="c1">// (1) Headers plus request line size does not exceed its limit</span>
            <span class="c1">// (2) There are enough bytes to avoid expanding the buffer when</span>
            <span class="c1">// reading body</span>
            <span class="c1">// Technically, (2) is technical limitation, (1) is logical</span>
            <span class="c1">// limitation to enforce the meaning of headerBufferSize</span>
            <span class="c1">// From the way how buf is allocated and how blank lines are being</span>
            <span class="c1">// read, it should be enough to check (1) only.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">headerBufferSize</span> <span class="o">||</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">capacity</span><span class="o">()</span> <span class="o">-</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">socketReadBufferSize</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">sm</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"iib.requestheadertoolarge.error"</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">HeaderParseStatus</span><span class="o">.</span><span class="na">HAVE_MORE_HEADERS</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">HeaderParseStatus</span><span class="o">.</span><span class="na">DONE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">parsingHeader</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>parseHeaders主要由一个循环构成，循环内部不断读取header，如果出现以下两种情况则会抛出异常，</p>
<ol>
  <li>request line的大小加上当前已经读取的header的大小超过了headerBufferSize</li>
  <li>byteBuffer的剩余容量比socketReadBufferSize要小</li>
</ol>

<p>上面两种情况都会导致没有足够的空间存储后续的请求数据。
读取的工作主要由parseHeader来完成，解析过程和request line类似，也可以划分为几个步骤，</p>

<h2 id="阶段1-跳过空行">阶段1 跳过空行</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">//</span>
        <span class="c1">// Check for blank line</span>
        <span class="c1">//</span>

        <span class="kt">byte</span> <span class="n">chr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">headerParsePos</span> <span class="o">==</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_START</span><span class="o">)</span> <span class="o">{</span>

            <span class="c1">// Read new bytes if needed</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">fill</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span> <span class="o">{</span><span class="c1">// parse header</span>
                    <span class="n">headerParsePos</span> <span class="o">=</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_START</span><span class="o">;</span>
                    <span class="k">return</span> <span class="n">HeaderParseStatus</span><span class="o">.</span><span class="na">NEED_MORE_DATA</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="n">chr</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">CR</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Skip</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">LF</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">HeaderParseStatus</span><span class="o">.</span><span class="na">DONE</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>

        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">headerParsePos</span> <span class="o">==</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_START</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Mark the current buffer position</span>
            <span class="n">headerData</span><span class="o">.</span><span class="na">start</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">();</span>
            <span class="n">headerParsePos</span> <span class="o">=</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_NAME</span><span class="o">;</span>
        <span class="o">}</span>
</code></pre></div></div>
<p>解析的过程中使用headerParsePos来标示当前状态，</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">enum</span> <span class="n">HeaderParsePosition</span> <span class="o">{</span>
        <span class="cm">/**
         * 准备读取下一个HEADER, 如果在此状态下读取到\n\r则表示没有需要继续处理的HEADER了，
         * 如果读取到其他字符则进入到HEADER_NMAE阶段
         */</span>
        <span class="n">HEADER_START</span><span class="o">,</span>
        <span class="cm">/**
         * 读取HEADER NAME。":"会出现在HEADER NAME之后，如果在":"之前出现任何non-HTTP_TOKEN_CHAR(包含)
         * 任意空白字符都会导致当前行被忽略
         */</span>
        <span class="n">HEADER_NAME</span><span class="o">,</span>
        <span class="cm">/**
         * 该阶段用于跳过HEADER VALUE之前的空白字符，这个字符有可能出现在HEADER VALUE的首行，也可能出现在后续的
         * 行中。
         */</span>
        <span class="n">HEADER_VALUE_START</span><span class="o">,</span>
        <span class="cm">/**
         * 读取数据。当状态处于HEADER_VALUE_START时，如果遇到第一个非空格和\t，则进入到HEADER_VALUE阶段
         */</span>
        <span class="n">HEADER_VALUE</span><span class="o">,</span>

        <span class="n">HEADER_MULTI_LINE</span><span class="o">,</span>

        <span class="n">HEADER_SKIPLINE</span>
    <span class="o">}</span>
</code></pre></div></div>

<h2 id="阶段2-读取header-name">阶段2 读取header name</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">//</span>
        <span class="c1">// Reading the header name</span>
        <span class="c1">// Header name is always US-ASCII</span>
        <span class="c1">//</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">headerParsePos</span> <span class="o">==</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_NAME</span><span class="o">)</span> <span class="o">{</span>

            <span class="c1">// Read new bytes if needed</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">fill</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// parse header</span>
                    <span class="k">return</span> <span class="n">HeaderParseStatus</span><span class="o">.</span><span class="na">NEED_MORE_DATA</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">();</span>
            <span class="n">chr</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">COLON</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">headerParsePos</span> <span class="o">=</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_VALUE_START</span><span class="o">;</span>
                <span class="n">headerData</span><span class="o">.</span><span class="na">headerValue</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="na">addValue</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="n">headerData</span><span class="o">.</span><span class="na">start</span><span class="o">,</span>
                        <span class="n">pos</span> <span class="o">-</span> <span class="n">headerData</span><span class="o">.</span><span class="na">start</span><span class="o">);</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">();</span>
                <span class="c1">// Mark the current buffer position</span>
                <span class="n">headerData</span><span class="o">.</span><span class="na">start</span> <span class="o">=</span> <span class="n">pos</span><span class="o">;</span>
                <span class="n">headerData</span><span class="o">.</span><span class="na">realPos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">;</span>
                <span class="n">headerData</span><span class="o">.</span><span class="na">lastSignificantChar</span> <span class="o">=</span> <span class="n">pos</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">HttpParser</span><span class="o">.</span><span class="na">isToken</span><span class="o">(</span><span class="n">chr</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// If a non-token header is detected, skip the line and</span>
                <span class="c1">// ignore the header</span>
                <span class="n">headerData</span><span class="o">.</span><span class="na">lastSignificantChar</span> <span class="o">=</span> <span class="n">pos</span><span class="o">;</span>
                <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
                <span class="k">return</span> <span class="nf">skipLine</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="c1">// chr is next byte of header name. Convert to lowercase.</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">chr</span> <span class="o">&gt;=</span> <span class="n">Constants</span><span class="o">.</span><span class="na">A</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">chr</span> <span class="o">&lt;=</span> <span class="n">Constants</span><span class="o">.</span><span class="na">Z</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">byteBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">pos</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="n">chr</span> <span class="o">-</span> <span class="n">Constants</span><span class="o">.</span><span class="na">LC_OFFSET</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre></div></div>
<p>如协议所示当读取到的字符是”:”的时候进入到下一个阶段HEADER_VALUE_START。果在”:”之前读取到了非法字符则进入skipLine，skipLine首先会设置当前状态为HEADER_SKIPLINE，然后不断跳过\r直到读取到\n，然后重新进入到HEADER_START阶段，返回HAVE_MORE_HEADERS，在这种情况下parseHeaders会进入到下一个header的读取</p>

<h2 id="阶段3-读取value">阶段3 读取value</h2>
<p>在三种状态下都可以进入到阶段3，分别是HEADER_VALUE_START, HEADER_VALUE和HEADER_MULTI_LINE。如果当前阶段是HEADER_VALUE_START，则会不停的读取字符直到遇到非空格或者\t，然后进入到HEADER_VALUE阶段。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="k">if</span> <span class="o">(</span><span class="n">headerParsePos</span> <span class="o">==</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_VALUE_START</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Skipping spaces</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// Read new bytes if needed</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">())</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(!</span><span class="n">fill</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span> <span class="o">{</span><span class="c1">// parse header</span>
                            <span class="c1">// HEADER_VALUE_START</span>
                            <span class="k">return</span> <span class="n">HeaderParseStatus</span><span class="o">.</span><span class="na">NEED_MORE_DATA</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>

                    <span class="n">chr</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(!(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">SP</span> <span class="o">||</span> <span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">HT</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">headerParsePos</span> <span class="o">=</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_VALUE</span><span class="o">;</span>
                        <span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
</code></pre></div></div>
<p>如果当前阶段是HEADER_VALUE，则读取数据直到遇到\n，然后将状态设置为HEADER_MULTI_LINE。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="k">if</span> <span class="o">(</span><span class="n">headerParsePos</span> <span class="o">==</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_VALUE</span><span class="o">)</span> <span class="o">{</span>

                <span class="c1">// Reading bytes until the end of the line</span>
                <span class="kt">boolean</span> <span class="n">eol</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">(!</span><span class="n">eol</span><span class="o">)</span> <span class="o">{</span>

                    <span class="c1">// Read new bytes if needed</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">())</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(!</span><span class="n">fill</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span> <span class="o">{</span><span class="c1">// parse header</span>
                            <span class="c1">// HEADER_VALUE</span>
                            <span class="k">return</span> <span class="n">HeaderParseStatus</span><span class="o">.</span><span class="na">NEED_MORE_DATA</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>

                    <span class="n">chr</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">CR</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// Skip</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">LF</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">eol</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">SP</span> <span class="o">||</span> <span class="n">chr</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="na">HT</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">byteBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">headerData</span><span class="o">.</span><span class="na">realPos</span><span class="o">,</span> <span class="n">chr</span><span class="o">);</span>
                        <span class="n">headerData</span><span class="o">.</span><span class="na">realPos</span><span class="o">++;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">byteBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">headerData</span><span class="o">.</span><span class="na">realPos</span><span class="o">,</span> <span class="n">chr</span><span class="o">);</span>
                        <span class="n">headerData</span><span class="o">.</span><span class="na">realPos</span><span class="o">++;</span>
                        <span class="n">headerData</span><span class="o">.</span><span class="na">lastSignificantChar</span> <span class="o">=</span> <span class="n">headerData</span><span class="o">.</span><span class="na">realPos</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="c1">// Ignore whitespaces at the end of the line</span>
                <span class="n">headerData</span><span class="o">.</span><span class="na">realPos</span> <span class="o">=</span> <span class="n">headerData</span><span class="o">.</span><span class="na">lastSignificantChar</span><span class="o">;</span>

                <span class="c1">// Checking the first character of the new line. If the character</span>
                <span class="c1">// is a LWS, then it's a multiline header</span>
                <span class="n">headerParsePos</span> <span class="o">=</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_MULTI_LINE</span><span class="o">;</span>
            <span class="o">}</span>
</code></pre></div></div>
<p>如果当前状态是HEADER_MULTI_LINE，则会读取下一个字符，然后判断这个字符是否是空格或者\t，如果不是则表示进入到了下一个header，将当前转改标记为HEADER_START，退出循环。如果字符是空格或者\t，则表示当前header的value还没有读取完毕，重新设置状态为HEADER_VALUE_START，进入下一次循环继续读取数据。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">chr</span> <span class="o">=</span> <span class="n">byteBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">headerParsePos</span> <span class="o">==</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_MULTI_LINE</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">chr</span> <span class="o">!=</span> <span class="n">Constants</span><span class="o">.</span><span class="na">SP</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">chr</span> <span class="o">!=</span> <span class="n">Constants</span><span class="o">.</span><span class="na">HT</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">headerParsePos</span> <span class="o">=</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_START</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="c1">// Copying one extra space in the buffer (since there must</span>
                    <span class="c1">// be at least one space inserted between the lines)</span>
                    <span class="n">byteBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">headerData</span><span class="o">.</span><span class="na">realPos</span><span class="o">,</span> <span class="n">chr</span><span class="o">);</span>
                    <span class="n">headerData</span><span class="o">.</span><span class="na">realPos</span><span class="o">++;</span>
                    <span class="n">headerParsePos</span> <span class="o">=</span> <span class="n">HeaderParsePosition</span><span class="o">.</span><span class="na">HEADER_VALUE_START</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre></div></div>

<p>当上面三步都处理完成的时候，将bytebuffer中的数据设置到header-value中。到这里tomcat解析协议的流程就差不多走完了。接下来将进入到请求处理阶段。</p>
